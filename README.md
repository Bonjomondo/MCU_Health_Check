# MCU健康检测系统 (MCU Health Check System)

基于STM32F103C8T6的可穿戴健康监测系统

## 系统概述

本项目是一个完整的健康监测系统，实现了生命体征监测、运动感知、环境监测和数据存储传输等功能。采用裸机开发方式，使用标准库，通过时间片调度实现多任务管理。

## 硬件配置

### 主控芯片
- **STM32F103C8T6** - ARM Cortex-M3，72MHz

### 传感器模块

#### 1. 生命体征监测
- **MAX30102** - 心率和血氧传感器
  - 接口: I2C (使用软件I2C on PB10/PB11)
  - 功能: PPG光电容积脉搏波测量
  - 测量参数: 心率(HR)、血氧饱和度(SpO2)

- **DS18B20** - 体温传感器
  - 接口: One-Wire (PA1)
  - 功能: 接触式体表温度测量
  - 测量范围: -55°C ~ +125°C
  - 精度: ±0.5°C

#### 2. 运动与环境感知
- **MPU6050** - 六轴陀螺仪加速度计
  - 接口: I2C (PB10/PB11)
  - 功能: 运动状态检测、久坐提醒
  - 输出: 3轴加速度、3轴角速度

- **SHT30** - 温湿度传感器
  - 接口: I2C (PB10/PB11)
  - 功能: 环境温湿度监测
  - 测量范围: 温度(-40~125°C)，湿度(0~100%RH)

#### 3. 人机交互
- **0.96寸OLED显示屏** - 信息显示
  - 接口: I2C (PB10/PB11)
  - 分辨率: 128x64
  - 显示内容: 健康数据、环境信息、系统状态

- **按键输入** - 4个按键
  - KEY1 (PC13): 切换显示页面
  - KEY2 (PC14): 开始/停止测量
  - KEY3 (PC15): 保存数据到Flash
  - KEY4 (PA0): 手动触发提醒

- **蜂鸣器** (PA3) - 声音反馈
  - 功能: 异常值报警、操作提示

- **震动马达** (PA2) - 触觉反馈
  - 功能: 测量完成提醒、久坐提醒、按键反馈

#### 4. 数据通信与存储
- **HC-05蓝牙模块** - 无线通信
  - 接口: USART1
  - 波特率: 9600
  - 功能: 数据发送到手机APP

- **W25Q64 Flash存储** - 离线数据存储
  - 接口: SPI (PA4-CS, PA5-SCK, PA6-MISO, PA7-MOSI)
  - 容量: 8MB
  - 功能: 历史数据存储

## 引脚分配

根据原理图(MCU_Health_Check.png)的引脚分配：

| 模块 | 引脚 | 功能 |
|------|------|------|
| OLED | PB10 | I2C_SCL |
| OLED | PB11 | I2C_SDA |
| MAX30102 | PB10/PB11 | I2C (共享总线) |
| MPU6050 | PB10/PB11 | I2C (共享总线) |
| SHT30 | PB10/PB11 | I2C (共享总线) |
| DS18B20 | PA1 | One-Wire |
| W25Q64 | PA4 | SPI_CS |
| W25Q64 | PA5 | SPI_SCK |
| W25Q64 | PA6 | SPI_MISO |
| W25Q64 | PA7 | SPI_MOSI |
| Buzzer | PA3 | GPIO_OUT |
| Motor | PA2 | GPIO_OUT |
| KEY1 | PC13 | GPIO_IN (上拉) |
| KEY2 | PC14 | GPIO_IN (上拉) |
| KEY3 | PC15 | GPIO_IN (上拉) |
| KEY4 | PA0 | GPIO_IN (上拉) |

## 软件架构

### 时间片调度器
- 基于SysTick的1ms时基
- 支持最多10个任务
- 每个任务可设置独立的运行周期
- 非抢占式调度

### 任务列表

| 任务名称 | 周期 | 功能 |
|---------|------|------|
| Task_HeartRateSpO2 | 50ms | 心率血氧数据采集 |
| Task_Temperature | 1000ms | 体温测量 |
| Task_MotionDetect | 100ms | 运动状态检测 |
| Task_Environment | 2000ms | 环境温湿度监测 |
| Task_IdleAlert | 10000ms | 久坐检测与提醒 |
| Task_DataTransmit | 1000ms | 蓝牙数据传输 |
| Task_DisplayUpdate | 200ms | OLED显示更新 |
| Task_KeyScan | 10ms | 按键扫描 |

### 驱动模块

#### 通信协议层
- `MyI2C.c/h` - 软件I2C驱动
- `MySPI.c/h` - 软件SPI驱动
- `Serial.c/h` - USART驱动

#### 传感器驱动层
- `MAX30102.c/h` - 心率血氧传感器驱动
- `DS18B20.c/h` - 温度传感器驱动
- `MPU6050.c/h` - 六轴传感器驱动
- `SHT30.c/h` - 温湿度传感器驱动

#### 外设驱动层
- `OLED.c/h` - OLED显示驱动
- `Key.c/h` - 按键驱动
- `Buzzer.c/h` - 蜂鸣器驱动
- `Motor.c/h` - 震动马达驱动
- `W25Q64.c/h` - Flash存储驱动

#### 系统服务层
- `Scheduler.c/h` - 时间片调度器
- `Delay.c/h` - 延时函数

## 功能特性

### 1. 多页面显示
- **页面0 (主页)**: 心率、血氧、体温
- **页面1 (环境)**: 环境温度、湿度
- **页面2 (运动)**: 三轴加速度数据
- **页面3 (系统)**: 系统状态、运行时间

### 2. 健康监测
- 实时心率监测 (50-120 bpm正常范围)
- 血氧饱和度监测 (>90%正常)
- 体温监测 (35-38°C正常范围)
- 异常值自动报警

### 3. 运动检测
- 实时检测运动状态
- 久坐提醒 (默认30分钟)
- 运动数据可视化

### 4. 数据管理
- 实时蓝牙数据传输
- Flash历史数据存储
- 支持数据回读

### 5. 用户交互
- 按键切换页面
- 声音和震动反馈
- 直观的显示界面

## 使用说明

### 按键功能
1. **KEY1 (PC13)** - 按下切换显示页面，循环切换4个页面
2. **KEY2 (PC14)** - 按下开始/停止测量，蜂鸣器提示
3. **KEY3 (PC15)** - 按下保存当前数据到Flash，震动反馈
4. **KEY4 (PA0)** - 手动触发测量完成提醒

### 开机流程
1. 系统上电，显示欢迎界面
2. 初始化所有传感器和外设
3. 启动调度器，自动开始测量
4. 默认显示主页面

### 数据格式
蓝牙传输的数据格式：
```
HR:75,SpO2:98,Temp:36.5,EnvT:25.2,Hum:45.3
```

## 编译与下载

### 开发环境
- **IDE**: Keil MDK-ARM
- **标准库**: STM32F10x Standard Peripheral Library v3.5.0
- **调试器**: ST-Link

### 编译步骤
1. 打开 `Project.uvprojx`
2. 选择目标: STM32F103C8
3. 编译项目 (F7)
4. 下载到目标板 (F8)

## 系统参数配置

### 健康阈值
可在 `main.c` 中修改：
```c
#define TEMP_LOW_THRESHOLD  35.0   // 体温下限
#define TEMP_HIGH_THRESHOLD 38.0   // 体温上限
#define HR_LOW_THRESHOLD    50     // 心率下限
#define HR_HIGH_THRESHOLD   120    // 心率上限
#define SPO2_LOW_THRESHOLD  90     // 血氧下限
#define IDLE_ALERT_TIME     1800000 // 久坐提醒时间(30分钟)
```

### 任务周期
可在 `main.c` 中调整各任务的运行周期：
```c
Scheduler_AddTask(Task_HeartRateSpO2, 50);    // 修改第二个参数
```

## 注意事项

1. **I2C总线共享**: MAX30102、MPU6050、SHT30和OLED共享同一I2C总线(PB10/PB11)，注意地址冲突
2. **温度传感器**: DS18B20需要750ms转换时间，任务周期设置为1000ms
3. **心率算法**: 当前使用简化算法，实际应用建议使用更复杂的峰值检测和滤波算法
4. **电源管理**: 建议添加低功耗模式以延长电池寿命
5. **数据校准**: 传感器可能需要校准以提高精度

## 扩展功能建议

1. **RTC时钟**: 添加实时时钟显示时间和日期
2. **睡眠监测**: 利用MPU6050检测睡眠质量
3. **心率变异性(HRV)**: 计算HRV指标评估压力水平
4. **数据云同步**: 通过WiFi模块上传数据到云平台
5. **电量管理**: 添加电池电量监测和低电量提醒
6. **更多传感器**: 集成ECG、血压等更多健康监测传感器

## 许可证

本项目基于STM32标准库开发，遵循相关开源协议。

## 作者

MCU Health Check System
Version: 1.0
Date: 2025-11-19
